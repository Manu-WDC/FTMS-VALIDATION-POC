name: FTMS Validation Callback

on:
  repository_dispatch:
    types: [ftms_validation_complete]

permissions:
  checks: write

jobs:
  process-results:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Receive callback
        run: |
          echo "================================"
          echo "ğŸ“¡ FTMS Callback Received"
          echo "================================"
          echo ""
          echo "Check Run ID: ${{ github.event.client_payload.check_run_id }}"
          echo "Status: ${{ github.event.client_payload.status }}"
          echo "Commit: ${{ github.event.client_payload.commit_sha }}"
          echo ""
          echo "ğŸ“Š Validation Details:"
          echo "  Total Tests: ${{ github.event.client_payload.validation_details.total_tests }}"
          echo "  Passed: ${{ github.event.client_payload.validation_details.passed }}"
          echo "  Failed: ${{ github.event.client_payload.validation_details.failed }}"
          echo "  Duration: ${{ github.event.client_payload.validation_details.duration_hours }} hours"
          echo "  Environment: ${{ github.event.client_payload.validation_details.test_environment }}"
      
      - name: âœ… Update GitHub Check
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;
            const isPassed = payload.status === 'PASS';
            const conclusion = isPassed ? 'success' : 'failure';
            const emoji = isPassed ? 'âœ…' : 'âŒ';
            
            console.log(`Updating check ${payload.check_run_id} to ${conclusion}...`);
            
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: payload.check_run_id,
              status: 'completed',
              conclusion: conclusion,
              completed_at: new Date().toISOString(),
              output: {
                title: `${emoji} FTMS On-Drive Validation ${payload.status}`,
                summary: isPassed 
                  ? 'ğŸ‰ All on-drive validation tests passed! PR is unblocked and ready to merge.'
                  : 'âŒ Some validation tests failed. Please review the results and fix issues.',
                text: [
                  '## Validation Results',
                  '',
                  `**Status:** ${emoji} **${payload.status}**`,
                  `**Commit:** \`${payload.commit_sha.substring(0, 7)}\``,
                  '',
                  '---',
                  '',
                  '### Test Summary',
                  '',
                  '| Metric | Value |',
                  '|--------|-------|',
                  `| Total Tests | ${payload.validation_details.total_tests} |`,
                  `| Passed | âœ… ${payload.validation_details.passed} |`,
                  `| Failed | ${payload.validation_details.failed > 0 ? 'âŒ' : 'âœ…'} ${payload.validation_details.failed} |`,
                  `| Duration | â±ï¸ ${payload.validation_details.duration_hours} hours |`,
                  `| Environment | ${payload.validation_details.test_environment} |`,
                  '',
                  '---',
                  '',
                  '### Stage Completion',
                  '',
                  '| Stage | Status |',
                  '|-------|--------|',
                  '| ğŸ”¨ Firmware Build | âœ… Complete |',
                  '| ğŸ“¤ Submit to FTMS | âœ… Complete |',
                  '| â° On-Drive Testing | âœ… Complete |',
                  `| ğŸ“Š Results Processing | ${isPassed ? 'âœ…' : 'âŒ'} ${payload.status} |`,
                  '',
                  '---',
                  '',
                  isPassed ? [
                    '### âœ… Next Steps',
                    '',
                    '- **PR Status:** UNBLOCKED âœ…',
                    '- Ready for code review',
                    '- Can be merged when approved',
                    '',
                    '---',
                    '',
                    '### ğŸ“Š Resource Comparison',
                    '',
                    '**Old Jenkins Flow:**',
                    '- Executor held: 24 hours',
                    '- Polling frequency: Every 5 minutes (288 polls)',
                    '- Resource waste: HIGH âŒ',
                    '',
                    '**New GitHub Flow:**',
                    '- Runner active: ~2 minutes total',
                    '- Polling: None (callback-based) âœ…',
                    '- Resource savings: 99.9% âœ…'
                  ].join('\n') : [
                    '### âŒ Next Steps',
                    '',
                    '- **PR Status:** BLOCKED âŒ',
                    '- Review failed tests',
                    '- Fix issues in code',
                    '- Push new commit to retrigger validation',
                    '',
                    '---',
                    '',
                    '### ğŸ” Debugging',
                    '',
                    'Common failure reasons:',
                    '- Firmware compatibility issues',
                    '- Performance regressions',
                    '- Drive communication errors',
                    '',
                    'Check FTMS logs for detailed error messages.'
                  ].join('\n')
                ].join('\n')
              }
            });
            
            console.log(`âœ… Check updated successfully`);
            console.log(`PR is now ${isPassed ? 'UNBLOCKED âœ…' : 'BLOCKED âŒ'}`);
      
      - name: ğŸ¯ Summary
        run: |
          echo "================================"
          echo "âœ… Callback Processing Complete"
          echo "================================"
          echo ""
          echo "ğŸ“Š Total Resource Usage:"
          echo "  - Initial workflow: ~30 seconds"
          echo "  - Callback workflow: ~10 seconds"
          echo "  - Total: ~40 seconds"
          echo ""
          echo "ğŸ’° Savings vs Jenkins polling:"
          echo "  - Old: 24 hours of executor time"
          echo "  - New: 40 seconds of runner time"
          echo "  - Saved: 23h 59m 20s (99.95%!)"