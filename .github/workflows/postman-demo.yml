name: Postman Callback Demo

# This workflow exits IMMEDIATELY after creating the check
# Use Postman to send the callback and unblock the PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  checks: write
  contents: read
  pull-requests: read

jobs:
  build-and-exit:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üî® Build Firmware (Simulated)
        run: |
          echo "========================================"
          echo "üî® Building firmware..."
          echo "========================================"
          sleep 3
          echo "‚úÖ Build complete!"
      
      - name: üìù Create Check (Blocks PR)
        id: create-check
        uses: actions/github-script@v7
        with:
          script: |
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const headSha = context.payload.pull_request.head.sha;
            
            const check = await github.rest.checks.create({
              owner: repoOwner,
              repo: repoName,
              name: 'FTMS Postman Demo',
              head_sha: headSha,
              status: 'in_progress',
              started_at: new Date().toISOString(),
              output: {
                title: '‚è≥ Waiting for Postman Callback',
                summary: 'üîí PR is BLOCKED. Use Postman to send callback. Check the workflow logs for the Check Run ID and instructions.'
              }
            });
            
            const checkId = check.data.id;
            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/check-runs/${checkId}`;
            
            console.log('');
            console.log('========================================');
            console.log('‚úÖ CHECK CREATED - PR IS BLOCKED');
            console.log('========================================');
            console.log('');
            console.log('üìã CHECK RUN ID: ' + checkId);
            console.log('');
            console.log('========================================');
            console.log('üìÆ POSTMAN INSTRUCTIONS');
            console.log('========================================');
            console.log('');
            console.log('1. Open Postman');
            console.log('2. Create a PATCH request');
            console.log('');
            console.log('URL:');
            console.log(apiUrl);
            console.log('');
            console.log('HEADERS:');
            console.log('  Authorization: token YOUR_GITHUB_TOKEN');
            console.log('  Accept: application/vnd.github.v3+json');
            console.log('  Content-Type: application/json');
            console.log('');
            console.log('BODY (raw JSON):');
            console.log('{');
            console.log('  "status": "completed",');
            console.log('  "conclusion": "success",');
            console.log('  "output": {');
            console.log('    "title": "‚úÖ FTMS Validation PASSED",');
            console.log('    "summary": "Callback from Postman! PR unblocked."');
            console.log('  }');
            console.log('}');
            console.log('');
            console.log('========================================');
            
            core.setOutput('check_id', checkId);
            core.setOutput('api_url', apiUrl);
      
      - name: üì§ Submit to FTMS (Simulated)
        run: |
          echo ""
          echo "========================================"
          echo "üì§ Submitting to FTMS..."
          echo "========================================"
          echo ""
          echo "In production:"
          echo "  - This would call real FTMS API"
          echo "  - FTMS would run tests for 24 hours"
          echo "  - FTMS would call back when done"
          echo ""
          echo "For this demo:"
          echo "  - Use Postman to simulate callback"
          echo ""
      
      - name: üöÄ Exit Workflow
        run: |
          echo ""
          echo "========================================"
          echo "üöÄ WORKFLOW EXITING NOW!"
          echo "========================================"
          echo ""
          echo "‚úÖ Runner is now FREE"
          echo "üîí PR is BLOCKED (waiting for callback)"
          echo ""
          echo "üìÆ Use Postman to send callback"
          echo "   and unblock the PR!"
          echo ""
          echo "Look at the logs above for:"
          echo "  - Check Run ID"
          echo "  - API URL"
          echo "  - Postman instructions"
          echo ""
          echo "========================================"
