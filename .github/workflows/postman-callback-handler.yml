name: Postman Callback Handler

# This workflow is triggered by Postman via repository_dispatch
# It updates the check run to unblock the PR

on:
  repository_dispatch:
    types: [ftms_callback]

permissions:
  checks: write

jobs:
  update-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: üîî Process Callback from Postman
        uses: actions/github-script@v7
        with:
          script: |
            const checkRunId = context.payload.client_payload.check_run_id;
            const status = context.payload.client_payload.status || 'PASS';
            const isPassed = status === 'PASS';
            
            console.log('========================================');
            console.log('üîî CALLBACK RECEIVED FROM POSTMAN');
            console.log('========================================');
            console.log('');
            console.log('Check Run ID: ' + checkRunId);
            console.log('Status: ' + status);
            console.log('');
            
            const conclusion = isPassed ? 'success' : 'failure';
            const emoji = isPassed ? '‚úÖ' : '‚ùå';
            
            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: checkRunId,
              status: 'completed',
              conclusion: conclusion,
              completed_at: new Date().toISOString(),
              output: {
                title: emoji + ' FTMS Validation ' + status,
                summary: isPassed 
                  ? 'üéâ Callback received from Postman! PR is now UNBLOCKED.'
                  : '‚ùå Validation failed. PR remains blocked.',
                text: [
                  '## üìÆ Callback Details',
                  '',
                  '- **Source:** Postman (External)',
                  '- **Status:** ' + status,
                  '- **Check Run ID:** ' + checkRunId,
                  '',
                  '---',
                  '',
                  '## üéØ What This Proves',
                  '',
                  '1. ‚úÖ External system (Postman) triggered this callback',
                  '2. ‚úÖ GitHub received and processed the callback',
                  '3. ‚úÖ Check status updated successfully',
                  isPassed ? '4. ‚úÖ PR is now UNBLOCKED!' : '4. ‚ùå PR remains blocked',
                  '',
                  '---',
                  '',
                  '## üìä Resource Summary',
                  '',
                  '| Phase | Duration | Resources |',
                  '|-------|----------|-----------|',
                  '| Build & Submit | ~15 sec | GitHub runner |',
                  '| Wait for FTMS | Any duration | **NONE** ‚úÖ |',
                  '| This Callback | ~5 sec | GitHub runner |',
                  '',
                  '**Total GitHub time: ~20 seconds**',
                  '**Jenkins equivalent: 24 hours**',
                  '**Savings: 99.98%**'
                ].join('\n')
              }
            });
            
            console.log('');
            console.log('========================================');
            console.log('‚úÖ CHECK UPDATED TO: ' + conclusion.toUpperCase());
            console.log('========================================');
            console.log('');
            if (isPassed) {
              console.log('üéâ PR IS NOW UNBLOCKED!');
            } else {
              console.log('‚ùå PR REMAINS BLOCKED');
            }

